<html>
    <head>
		<script type="text/javascript" src="sylvester-0-1-3/sylvester.js"></script>
        <script type="text/javascript" src="gl.js"></script>
        <script type="text/javascript" src="mesh.js"></script>
        <script type="text/javascript" src="material.js"></script>
        <script type="text/javascript" src="scenegraph.js"></script>
        <script type="text/javascript" src="mathextras.js"></script>
		<script type="text/javascript" src="glUtil.js"></script>
		<script type="text/javascript">
			var mvMatrix;
			var perspectiveMatrix;
			
			function loadIdentity() {
				mvMatrix = Matrix.I(4);
			}

			function multMatrix(m) {
				mvMatrix = mvMatrix.x(m);
			}

			function mvTranslate(v) {
				multMatrix(Matrix.Translation($V([v[0], v[1], v[2]])).ensure4x4());
			}

			function setMatrixUniforms(shader) {
				gl.useProgram(shader.program);
				var pUniform = gl.getUniformLocation(shader.program, "uPMatrix");
				gl.uniformMatrix4fv(pUniform, false, new Float32Array(perspectiveMatrix.flatten()));

				var mvUniform = gl.getUniformLocation(shader.program, "uMVMatrix");
				gl.uniformMatrix4fv(mvUniform, false, new Float32Array(mvMatrix.flatten()));
			}
		</script>
        <script type="text/javascript">
            function start() {
                var canvas = document.getElementById("glcanvas");
				LogElement = document.getElementById("err_log");
				
                initGL(canvas);
				
				var Scene = new SceneObject();
				Scene.name = "Scene";
				
				var testSquare = new SceneObject("Square", createSquareMesh(1.0, $V([0, 0, 1]), false));
				testSquare.mesh._packArrays();
				testSquare.material.addShader("basic", "shader-vs", "shader-fs");
				Scene.addChild(testSquare);
				
				var testTri = new SceneObject("Tri", createSingleTriangleMesh([1.0, 1.0, 0.0], // 
																			  [-1.0, -1.0, 0.0], //
									                                          [1.0, -1.0, 0.0], false));
				testTri.material.addShader("basic", "shader-vs", "shader-fs");
				
				testTri.material.setProjectionMatrix(makePerspective(45, 640.0/480.0, 0.1, 100.0);
  
				//loadIdentity();
				//mvTranslate([-0.0, 0.0, -3.0]);
				
				//setMatrixUniforms(testSquare.material.shaders[0]);
				//setMatrixUniforms(testTri.material.shaders[0]);
				
				Scene.draw();
            }
        </script>
		<script id="shader-fs" type="x-shader/x-fragment">
			// specifies floating point precision
			precision mediump float;
			
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUv;
		
			void main(void) {
				// convert the position from range [-1, 1] to [0, 1] for colors
				gl_FragColor = (oPosition + 1.0) * 0.5;
			}
		</script>
		<script id="shader-vs" type="x-shader/x-vertex">
			attribute vec3 position;
			attribute vec3 normal;
			attribute vec2 uv;
			
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUv;
			
			// model view matrix (positioning in space of your vertex)
			uniform mat4 uMVMatrix;
			// perspective matrix (camera)
			uniform mat4 uPMatrix;

			void main(void) {
				oPosition = vec4(position, 1.0);
				gl_Position = uPMatrix * uMVMatrix * oPosition;
				oNormal = normal;
				oUv = uv;
			}
		</script>
		<script id="outline-fs" type="x-shader/x-fragment">
			precision mediump float;
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUv;

			uniform vec4 outlineColor;
			
			void main(void) {
				gl_FragColor = outlineColor;
			}
		</script>
		<script id="outline-vs" type="x-shader/x-vertex">
			attribute vec3 position;
			attribute vec3 normal;
			attribute vec2 uv;
			
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUv;
			
			// model matrix (positioning in space of your vertex)
			uniform mat4 modelMatrix;
			// camera positioning
			uniform mat4 viewMatrix;
			// perspective matrix (perspective projection camera)
			uniform mat4 perspectiveMatrix;

			// uniform specifying how much to scale the mesh for an outline
			uniform float outlineScale;
			
			void main(void) {
				// pass normal, uv, and position through
				oPosition = vec4(position, 1.0);
				oNormal = normal;
				oUv = uv;
				
				// scale the mesh uniformly to make it into an outline
				oPosition = oPosition * outlineScale;
				
				// modify vertex pos by MVP (because col major PVM) matrix
				gl_Position = perspectiveMatrix * viewMatrix * modelMatrix * oPosition;
			}
		</script>
    </head>
    <body onload="start();">
        <canvas id="glcanvas" width="640" height="480">
            Browser does not support the <code>&lt;canvas&gt;</code> element.
        </canvas>
		<div id="err_log"></div>
    </body>
</html>
