<html>
    <head>
		<script type="text/javascript" src="sylvester-0-1-3/sylvester.js"></script>
        <script type="text/javascript" src="gl.js"></script>
        <script type="text/javascript" src="mesh.js"></script>
        <script type="text/javascript" src="material.js"></script>
        <script type="text/javascript" src="scenegraph.js"></script>
        <script type="text/javascript" src="mathextras.js"></script>
		<script type="text/javascript" src="glUtil.js"></script>
		<script type="text/javascript">
			function loadIdentity() {
				mvMatrix = Matrix.I(4);
			}

			function multMatrix(m) {
				mvMatrix = mvMatrix.x(m);
			}

			function mvTranslate(v) {
				multMatrix(Matrix.Translation($V([v[0], v[1], v[2]])).ensure4x4());
			}

			function setMatrixUniforms(shader) {
				gl.useProgram(shader.program);
				var pUniform = gl.getUniformLocation(shader.program, "uPMatrix");
				gl.uniformMatrix4fv(pUniform, false, new Float32Array(perspectiveMatrix.flatten()));

				var mvUniform = gl.getUniformLocation(shader.program, "uMVMatrix");
				gl.uniformMatrix4fv(mvUniform, false, new Float32Array(mvMatrix.flatten()));
			}
		</script>
        <script type="text/javascript">
            function start() {
                var canvas = document.getElementById("glcanvas");
				LogElement = document.getElementById("err_log");
				
                initGL(canvas);
				
				var Scene = new SceneObject();
				Scene.name = "Scene";
				
				var testSquare = new SceneObject("Square", createSquareMesh(1.0, true));
				testSquare.material.addShader("basic", "shader-vs", "shader-fs");
				//testSquare.material.shaders[0].
				Scene.addChild(testSquare);
				LogError("Test square: " + testSquare.toString());
				
				perspectiveMatrix = makePerspective(45, 640.0/480.0, 0.1, 100.0);
  
				loadIdentity();
				mvTranslate([-0.0, 0.0, -6.0]);
				
				setMatrixUniforms(testSquare.material.shaders[0]);
				
				Scene.draw();
            }
        </script>
		<script id="shader-fs" type="x-shader/x-fragment">
			precision mediump float;
			
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUv;
		
			void main(void) {
				gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
			}
		</script>
		<script id="shader-vs" type="x-shader/x-vertex">
			attribute vec3 position;
			attribute vec3 normal;
			attribute vec2 uv;
			
			varying vec4 oPosition;
			varying vec3 oNormal;
			varying vec2 oUv;

			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;

			void main(void) {
				oPosition = vec4(position, 1.0);
				// gl_Position = uPMatrix * uMVMatrix * oPosition;
				gl_Position = oPosition;
				oNormal = normal;
				oUv = uv;
			}
		</script>
    </head>
    <body onload="start();">
        <canvas id="glcanvas" width="640" height="480">
            Browser does not support the <code>&lt;canvas&gt;</code> element.
        </canvas>
		<div id="err_log"></div>
    </body>
</html>
